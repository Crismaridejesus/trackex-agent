name: Build macOS App 2

on:
  workflow_dispatch:

jobs:
  build:
    name: Build MacOS
    runs-on: macos-latest
    defaults:
      run:
        working-directory: Desktop/trackex-agent

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: rm -rf node_modules package-lock.json && npm install --include=optional

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version ^2.0.0 --locked

      - name: Import Code Signing Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p actions temp.keychain
          security default-keychain -s temp.keychain
          security unlock-keychain -p actions temp.keychain
          security set-keychain-settings -lut 21600 temp.keychain
          security import certificate.p12 -k temp.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign -T /usr/bin/productbuild -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions temp.keychain
          security find-identity -v temp.keychain
          rm certificate.p12

      - name: Build Tauri app (macOS)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          CI: true
        run: npm run tauri build

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TrackEx-Agent-macos
          path: |
            Desktop/trackex-agent/src-tauri/target/release/bundle/dmg/TrackEx Agent_*.dmg
            Desktop/trackex-agent/src-tauri/target/release/bundle/dmg/TrackEx Agent_*.dmg.sig
            Desktop/trackex-agent/src-tauri/target/release/bundle/macos/TrackEx Agent.app.tar.gz
            Desktop/trackex-agent/src-tauri/target/release/bundle/macos/TrackEx Agent.app.tar.gz.sig
          if-no-files-found: warn